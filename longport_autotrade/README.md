# Longport AutoTrade

这是一个基于 Python 的自动化股票交易脚本，专为 **DXYZ (Destiny Tech100 Inc.)** 等高波动性标的设计。

该脚本采用 **双 API 架构**：利用 **Finnhub API** 进行低成本的实时行情监控，并通过 **Longport Open API (长桥证券)** 执行交易指令。

---

## 📋 目录

1. [核心功能](#-核心功能)
2. [交易策略](#交易策略)
3. [环境依赖与安装](#-环境依赖与安装)
4. [配置与使用方法](#-配置与使用方法)
5. [优缺点分析](#-优缺点分析)
6. [版本更新](#-版本更新)
7. [免责声明](#-免责声明)

---

## ✨ 核心功能

* **双 API 驱动**：
    * **行情 (Data)**: 使用 Finnhub 获取实时报价，独立于交易接口，避免单一接口频率限制。
    * **交易 (Execution)**: 使用 Longport SDK 进行毫秒级下单、撤单及资产查询。
* **多股并行监控**：
    * 支持同时配置多个目标股票（如 DXYZ, NVDA）。
    * 利用 `threading` 多线程技术，每只股票独立监控，互不阻塞。
* **状态持久化 (断点续传)**：
    * 脚本实时将持仓状态（成本价、最高价、持仓量）写入 `trade_state.json`。
    * **异常恢复**：若程序崩溃或手动停止，重启时可选择“恢复状态”，继续执行原有的止损/止盈逻辑，防止策略失效。
* **安全敏感信息管理**：
    * 所有 API Key 和 Token 均通过系统 **环境变量** 读取，杜绝代码硬编码导致的信息泄露。
* **无缝实盘切换**：
    * 只需更改环境变量中的 Token，即可在“长桥模拟盘”与“实盘”间无缝切换，无需修改代码逻辑。

---

## 🧠 交易策略

###  DXYZ 

本脚本的核心目标是：**在严格控制回撤（不亏大钱）的基础上，通过移动止盈追求利润最大化。**

#### 1. 入场机制 (Buy Signal)
* **前提**：
    1. 当前无持仓。
    2. **不在冷却期内**（距离上次卖出超过 30 分钟）。
    3. **美股盘中时间**（09:30 - 16:00 ET）。
* **触发条件**：
    * **价格动量**: 日内涨幅 `(当前价 - 开盘价) / 开盘价` > `BUY_MOMENTUM_THRESHOLD` (默认 **1.5%**)。
    * **成交量确认**: 当前成交量 > `MIN_VOLUME_THRESHOLD` (默认 **10000**)，确保有资金承接。
* **执行动作**: 以 `当前价 * (1 + 滑点)` 的价格挂限价买单。

#### 2. 离场机制 (Exit Signal) - 双重风控
一旦持有仓位，脚本将启动以下防线，并在**触发任一卖出后进入冷却期**：

##### A. 硬止损 (Hard Stop Loss) —— 保命线
* **触发条件**：当前价格跌破入场成本价的 `STOP_LOSS_PCT` (默认 **3%**)。
* **执行动作**：以 `当前价 * (1 - 滑点)` 卖出。
* **目的**：防止深度套牢，强制截断亏损。

##### B. 动态阶梯移动止盈 (Dynamic Trailing Stop) —— 锁利线
不再使用固定的回撤比例，而是根据**浮盈比例 (Max PnL)** 动态调整回撤容忍度：

* **阶段 1 (微利/保本)**: 最高浮盈 > 3% 时，允许回撤 **3%**。
* **阶段 2 (趋势确立)**: 最高浮盈 > 10% 时，允许回撤 **6%**。
* **阶段 3 (超级行情)**: 最高浮盈 > 20% 时，允许回撤 **10%**（为了捕捉更大的鱼身）。

---

## 🛠 环境依赖与安装

### 1. 系统要求
* Python 3.8 或更高版本
* 支持 Windows / macOS / Linux

### 2. 安装 Python 库
在终端中运行以下命令安装所需依赖：
```bash
pip install longport finnhub-python pytz
```
v0.1.4 版本新增了 `pytz` 用于处理时区问题。


---

## ⚙️ 配置与使用方法

### 第一步：获取 API 凭证

1.  **Longport (长桥证券)**:
    * 登录 [长桥开发者中心](https://open.longportapp.com/)。
    * 申请 Open API 权限，获取 `App Key`, `App Secret`。
    * 生成 `Access Token` (注意：**Paper** 为模拟盘 Token，**Live** 为实盘 Token)。
2.  **Finnhub**:
    * 注册 [Finnhub.io](https://finnhub.io/)。
    * 在 Dashboard 获取免费的 `API Key`。

### 第二步：设置环境变量 (关键)

**为了安全，请勿将 Key 直接写入代码！** 请在终端设置环境变量。

**macOS / Linux:**
```bash
export LONGPORT_APP_KEY="你的长桥AppKey"
export LONGPORT_APP_SECRET="你的长桥AppSecret"
export LONGPORT_ACCESS_TOKEN="你的长桥AccessToken"
export FINNHUB_API_KEY="你的FinnhubKey"
```

**Windows (PowerShell):**
```powershell
$env:LONGPORT_APP_KEY="你的长桥AppKey"
$env:LONGPORT_APP_SECRET="你的长桥AppSecret"
$env:LONGPORT_ACCESS_TOKEN="你的长桥AccessToken"
$env:FINNHUB_API_KEY="你的FinnhubKey"
```

### 第三步：调整策略参数 (可选)

打开 `longport_autotrade.py`，在文件顶部的配置区域进行修改：

```python
TARGET_STOCKS = {
    "DXYZ": {
        "budget": 1000,          # 投资金额 (USD)
        "strategy_type": "dxyz_dynamic"
    }
}

# --- 核心策略参数 ---
POLLING_INTERVAL = 5            # 监控频率 (秒)
STOP_LOSS_PCT = 0.03            # 3% 硬止损
BUY_MOMENTUM_THRESHOLD = 0.015  # 1.5% 动量买入阈值

# --- [v0.2 新增参数] ---
SLIPPAGE_PCT = 0.01             # 滑点容忍度 (1%)
COOLDOWN_MINUTES = 30           # 卖出后冷却时间 (分钟)，防止频繁止损
MIN_VOLUME_THRESHOLD = 10000    # 最小成交量过滤
```

### 第四步：运行脚本

```bash
python longport_autotrade.py
```

* **启动交互**：脚本启动时会检测是否存在历史状态文件。
    * 输入 `y`: **继续运行**（恢复上次的持仓数据，适用于盘中重启）。
    * 输入 `n`: **重新开始**（清空状态，适用于新的一天）。
* **手动退出**：在终端按 `Ctrl + C`，脚本会保存当前状态并安全退出。

---

## ⚖️ 优缺点分析

| 维度 | 优点 (Pros) | 缺点 (Cons) |
| :--- | :--- | :--- |
| **执行速度** | 毫秒级下单，严格执行纪律，克服人性贪婪与恐惧。 | 极端行情（如熔断、跳空）下可能存在滑点 (Slippage)。 |
| **成本** | 利用 Finnhub 免费版数据，降低订阅成本。 | Finnhub 免费版有频率限制 (约 60次/分钟)，可能存在秒级延迟。 |
| **风控** | 结合硬止损与移动止盈，最大程度保护本金。 | 在震荡市（横盘整理）中可能会频繁止损，造成连续小额磨损。 |
| **稳定性** | 具备状态保存功能，不怕断网或程序崩溃。 | 依赖本地网络环境，如果本地断网，监控将失效。 |

---

## 📅 版本更新

* **v0.1.0**: 初始版本发布。
    * 集成 Longport Trade API 与 Finnhub Quote API。
    * 利用 `yfinance` 获取 5 分钟线计算 MA、RSI 等技术指标，同时通过 `Finnhub` 获取秒级实时现价，弥补指标延迟。
    * 内置经典的“均线金叉/死叉 + RSI 过滤”策略。
        * MA5 上穿 MA20（金叉）。
        * 且 RSI < 70（防止超买）。
        * 买入后，记录价格到 `trade_state.json`。
        * 现价 < 买入价 * 0.95。直接卖出，保住本金。
        * MA5 下穿 MA20（死叉）**且** 现价 > 买入价。
        * 默认每 30 秒进行一次全量扫描。
* **v0.1.1**: 初始版本优化。
    * 添加 JSON 状态管理与多线程支持。
    * 增加了 `current_price > buy_price` 的判定，确保非止损情况下不亏损平仓。
* **v0.1.2**: 优化安全性与策略。
    * 支持配置多个目标股票。
    * 所有 API Key 和 Token 均通过系统环境变量读取。
    * 交易策略更新，实现 DXYZ 专用移动止损策略。
* **v0.1.3**: 动态策略与 API 优化版本。
    * **动态阶梯止盈 (Dynamic Trailing Stop)**: 放弃固定的回撤比例，改为根据盈利水平动态调整。
        * 盈利 > 3%: 3% 回撤止盈（保本逻辑）。
        * 盈利 > 10%: 6% 回撤止盈（过滤中度回撤）。
        * 盈利 > 20%: 10% 回撤止盈（捕捉超大行情）。
    * **入场过滤优化**: 提升买入阈值至 1.5%，进一步过滤早盘杂波。
* **v0.1.4**:风控体系重构。
New: 引入 Cool-down (冷却期) 机制，卖出后锁定 30 分钟。

New: 引入 Volume Filter (成交量过滤)。

New: 引入 Slippage Control (滑点控制)，使用限价单代替市价单。

Fix: 修复了旧版本在高位震荡时反复买入止损导致本金磨损的严重逻辑漏洞。
Fix: 引入 pytz 库，完美解决美股冬令时/夏令时 (EST/EDT) 切换问题。

Fix: 增加了周末过滤逻辑。

Fix: 为 Finnhub API 请求增加了重试机制 (Retry)，提高网络抗干扰能力。
---

## ⚠️ 免责声明 (Disclaimer)

1.  **风险提示**：本软件仅供 **技术交流与学习** 使用。股票交易（尤其是 DXYZ 及其衍生品）具有极高的资金风险。自动化交易可能因网络延迟、API 故障、交易所数据错误或代码逻辑漏洞导致资金损失。
2.  **实盘慎用**：作者不对使用本脚本产生的任何直接或间接盈亏负责。**强烈建议**先在长桥证券的 **模拟账户 (Paper Trading)** 中进行充分测试，确认策略稳定后再切换至实盘。
3.  **API 规范**：请严格遵守 Finnhub 和 Longport 的 API 使用协议，避免因高频调用导致 IP 被封禁。